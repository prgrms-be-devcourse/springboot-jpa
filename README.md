# μ¤ν”„λ§λ¶€νΈ JPA μ„ν΄λ¦¬ λ―Έμ…

# Github

https://github.com/SY97P/springboot-jpa.git

## π“ κ³Όμ  μ„¤λ…

- νμ–΄ν”„λ΅κ·Έλλ°

## π‘©β€π’» μ”κµ¬ μ‚¬ν•­κ³Ό κµ¬ν„ λ‚΄μ©

- [x]  λ―Έμ…1 : λ‹¨μΌ μ—”ν‹°ν‹°(Customer)λ¥Ό μ΄μ©ν• CRUDλ¥Ό κµ¬ν„
- [x]  λ―Έμ…2 : μμ†μ„± μ»¨ν…μ¤νΈ μƒλ…μ£ΌκΈ° μ‹¤μµ
- [x]  λ―Έμ…3 : 4-2. μ—°κ΄€κ΄€κ³„λ§¤ν•‘(order, order_item, itemμ μ—°κ΄€κ΄€κ³„ λ§¤ν•‘ μ‹¤μµ)

## β… ν”Όλ“λ°± λ°μμ‚¬ν•­

## π“®Β ν€λ―Έν… ν”Όλ“λ°±

- λΉλ” ν¨ν„΄ λΉ μ§„ μ†μ„± λ°©μ–΄
  - Assert.notNull() λ΅ λ°©μ–΄
- nullable μƒμ„±μ νλΌλ―Έν„°
  - μ»¬λΌμ— nullable = false
- ν…μ΄λΈ” μ΄λ¦„ μ»¨λ²¤μ…
  - λ¨λ‘ λ³µμν•
- μμ†μ„± μ „μ΄
  - μμ†, μ‚­μ  μ‹ λ¶€λ¨-κ΄€κ³„ μ„¤μ •ν• Order, OrderItemμ—λ§ μλ„ν• λ™μ‘ μν–‰λλ‹¤κ³  νλ‹¨
  - Cascade=All + κ³ μ•„κ°μ²΄ κ³ λ ¤ X

## π“®Β 1μ°¨ ν”Όλ“λ°±

### Validation λ¨λ“

- validation message λ¶€μ¬
  - [message.properties](http://message.properties) μ μ© κ°€λ¥μ„±
- `@Email` μ–΄λ…Έν…μ΄μ…
  - μ–΄λ…Έν…μ΄μ… μ μ©μ‚¬ν•­κ³Ό ν”„λ΅κ·Έλ¨ μ”κµ¬μ‚¬ν•­μ΄ λ‹¤λ¥Ό μ μμ
  - ν™•μΈν•κ³  μ‚¬μ©ν•λ” νΈμ΄ μΆ‹λ‹¤
- μ μ ν• μ–΄λ…Έν…μ΄μ…
  - nameμ—λ” `@Pattern` μΌλ΅ μ •κ·μ‹ μ μ©
  - age μ—λ” `@Min`, `@Max`, `@Positive` λ΅ μ ν¨κ°’ μ„ μ–Έ

### μ»¤μ¤ν…€ μ–΄λ…Έν…μ΄μ…

- ν…μ¤νΈ μ© μ–΄λ…Έν…μ΄μ…μ€ ν…μ¤νΈ ν¨ν‚¤μ§€ λ‚΄λ¶€μ— μ„ μ–Έν•΄μ•Ό ν•¨.
  - main ν¨ν‚¤μ§€μ— μ„ μ–Έν•λ©΄ ν…μ¤νΈμ© μ–΄λ…Έν…μ΄μ… import λ¶κ°€

    ```java
    @Target({ElementType.TYPE})
    @Retention(RetentionPolicy.RUNTIME)
    @Documented
    @Inherited
    @DataJpaTest
    @ActiveProfiles("test")
    @TestPropertySource(locations = "classpath:application-test.yaml")
    @AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
    public @interface JpaTest {
    }
    ```


### μ»¨λ²¤μ…

- private / public μ„μΉ μ»¨λ²¤μ…
  - private, public μ„ κµ¬λ¶„ν•΄μ„ λ‘λ” νΈμ΄ μΆ‹μ
  - λ€λ¶€λ¶„ public μ΄ μ„, privateμ΄ μ•„λ
- lombok, jakarta μ–΄λ…Έν…μ΄μ… μ„μΉ
  - λ΅¬λ³µ @EqualsAndHashCode μ–΄λ…Έν…μ΄μ…μ€ λ™λ“±μ„± λΉ„κµμ— λ¨λ“  ν•„λ“κ°€ κ°•μ λκΈ° λ•λ¬Έμ— μλ„ν• λ€λ΅ ν”„λ΅κ·Έλ¨μ΄ λ™μ‘ν•μ§€ μ•μ„ κ°€λ¥μ„± μ΅΄μ¬
- μ›μ‹κ°’ ν¬μ¥ ν•„λ“ λ³€μλ…
  - μ›μ‹κ°’ ν¬μ¥ ν΄λμ¤ μ΄λ¦„κ³Ό λ‹¤λ¥Έ μ΄λ¦„μΌλ΅ μ§€μ–΄μ•Ό ν•¨.

### Exception

- `RuntimeException` μ„ κ·Έλ€λ΅ λ³΄λ‚΄κΈ°λ³΄λ‹¨, μΆ€ λ” κµ¬μ²΄μ μΈ μμ™Έ λμ§€κΈ°
  - JpaRepositoryμ—μ„ κ²°κ³Ό μ—†μ„λ• `NoSuchElementException`
  - μƒν™©μ— λ§λ” μ μ ν• μμ™Έλ” λ€λ¶€λ¶„ μ΅΄μ¬ν•¨.

### JPA

- Entity Id κ°€ μμ°¨μ μΌλ΅ μ¦κ°€ν•λ” μ«μκ°’μΌ λ• λ‹¨μ μ€?
  1. λ¬Έμμ—΄λ΅ κµ¬μ„±λ ID λ³΄λ‹¤ μμΈ΅ μ‰¬μ›€ β†’ `λ³΄μ• μ΄μ`
  2. λ°μ΄ν„°λ² μ΄μ¤ λ³‘λ ¬ κµ¬μ„± μ‹ ID κ°’ `μ¤‘λ³µ νΉμ€ μ¶©λ` κ°€λ¥μ„±
- Delete λ‚΄λ¶€ κµ¬ν„
  1. μΌλ‹¨ μ—”ν‹°ν‹° null μ²΄ν¬
  2. μ—”ν‹°ν‹°κ°€ μƒλ΅ μƒμ„±λμ–΄μ•Ό ν•λ”μ§€ μ²΄ν¬
  3. ν”„λ΅μ‹λ΅ νƒ€μ… λ°›μ•„, entityManager (μμ†μ„± μ»¨ν…μ¤νΈ)μ—μ„ μ°Ύμ
  4. μ—”ν‹°ν‹°κ°€ μμ†μ„± μ»¨ν…μ¤νΈμ— μ΅΄μ¬ν•μ§€ μ•μΌλ©΄ μ•„λ¬΄ λ™μ‘ μ• ν•¨
  5. μμ†μ„± μ»¨ν…μ¤νΈμ— μ—”ν‹°ν‹°κ°€ μμΌλ©΄ μμ†, μ¤€μμ† κµ¬λ¶„μ—†μ΄ λ‹¤ κ°€μ Έμ™€μ„ μ κ±°

    ```java
    @Override
    @Transactional
    @SuppressWarnings("unchecked")
    public void delete(T entity) {
    
    	Assert.notNull(entity, "Entity must not be null");
    
    	if (entityInformation.isNew(entity)) {
    		return;
    	}
    
    	Class<?> type = ProxyUtils.getUserClass(entity);
    
    	T existing = (T) em.find(type, entityInformation.getId(entity));
    
    	// if the entity to be deleted doesn't exist, delete is a NOOP
    	if (existing == null) {
    		return;
    	}
    
    	em.remove(em.contains(entity) ? entity : em.merge(entity));
    }
    ```

- μ½κΈ° μ „μ© νΈλμ­μ… μ¥μ 
  1. μ¤μΉΌλΌ νƒ€μ…μΌλ΅ μ΅°ν

      ```java
      select o.id, o.name from Order p;
      ```

    - μ΅°ν κ²°κ³Όκ°€ μ—”ν‹°ν‹°κ°€ μ•„λ‹, μ¤μΉΌλΌ νƒ€μ…μΌλ΅ λ°ν™λλ„λ΅ μΏΌλ¦¬ μ‘μ„±
    - μ΅°ν κ²°κ³Όκ°€ μ—”ν‹°ν‹°κ°€ μ•„λ‹λ―€λ΅, μμ†μ„± μ»¨ν…μ¤νΈκ°€ κ²°κ³Όλ¥Ό κ΄€λ¦¬ν•μ§€ μ•μ
    - λ©”λ¨λ¦¬ μ μ•½
  2. μ½κΈ° μ „μ© μΏΌλ¦¬ ννΈ μ‚¬μ©
    - hibernate μ „μ© ννΈ readOnly μ΄μ©ν•΄ μ—”ν‹°ν‹°λ¥Ό μ½κΈ° μ „μ©μΌλ΅ μ΅°ν
    - μ½κΈ°μ „μ©μ΄κΈ° λ•λ¬Έμ— μμ†μ„± μ»¨ν…μ¤νΈλ” μ¤λƒ…μƒ· λ³΄κ΄€ X
    - λ©”λ¨λ¦¬ μ μ•½
  3. μ½κΈ° μ „μ© νΈλμ­μ… μ‚¬μ©

      ```java
      @Transactional(readOnly = true)
      ```

    - SpringFramework νΈλμ­μ… μ½κΈ° μ „μ© λ¨λ“ μ„¤μ •
    - SpringFrameworkκ°€ hibernate μ„Έμ… ν”λ¬μ‹ λ¨λ“λ¥Ό manualλ΅ μ„¤μ •
      - κ°•μ λ΅ Flush νΈμ¶ν•μ§€ μ•λ” ν•, flushλμ§€ μ•μ
      - **νΈλμ­μ…μ„ commit ν•λ”λΌλ„ μμ†μ„± μ»¨ν…μ¤νΈκ°€ flush λμ§€ μ•μ**
      - **μ—”ν‹°ν‹° λ“±λ΅, μμ •, μ‚­μ  λ™μ‘ν•μ§€ μ•μ**
      - μ½κΈ° μ „μ©μ΄λ―€λ΅, μμ†μ„± μ»¨ν…μ¤νΈκ°€ λ³€κ²½κ°μ§€λ¥Ό μ„ν• μ¤λƒ…μƒ· κ΄€λ¦¬λ¥Ό ν•μ§€ μ•μΌλ―€λ΅, λ©”λ¨λ¦¬ μ„±λ¥ ν–¥μƒ
  - Service λ μ΄μ–΄ μ „μ²΄μ— 3λ² μ½κΈ° μ „μ© νΈλμ­μ… μ„ μ–Έ + μ΅°ν μ΄μ™Έμ νΈλμ­μ…μ— λ©”μ†λ“ λ λ²¨ `@Transcational` μ„ μ–Έ
- `@Embedded` - `@Embeddable`
  - Entityμ—μ„  VO ν•„λ“μ— `@Embedded`
  - VO ν΄λμ¤μ— `@Embeddable`
  - Embedded ν΄λμ¤μ— `@Column`μΌλ΅ Entityμ„¤μ •ν•΄λ„ μ μ©λμ§€ μ•μ
    - VO ν΄λμ¤ λ‚΄λ¶€ ν•„λ“μ— `@Column(nullable = false)` μ΄λ° μ‹μΌλ΅ μ„ μ–Έν•΄μ•Ό ν•¨
- μ–‘λ°©ν–¥ μ—°κ΄€κ΄€κ³„ νΈμ λ©”μ†λ“
  - νΈμ λ©”μ†λ“λ” κ°μ²΄μ§€ν–¥μ— λ”°λΌ Aggregate Root μ—”ν‹°ν‹°μ— μ„ μ–Έν•λ” κ²ƒμ΄ μΆ‹μ
  - μµλ€ν• ν• μ½μ—λ§ μ„ μ–Έν•κ³ , μ–‘λ°©ν–¥ λ¨λ‘ λ§¤ν•‘μ΄ κ°€λ¥ν•λ„λ΅ ν•λ” κ²ƒ
- Dialect (λ°©μ–Έ)
  - κ°λ…
    - DB λ³„λ΅ ν‘μ¤€ ANSI SQL κ³Ό λ‹¤λ¥΄κ±°λ‚ μ¶”κ°€λ λ¬Έλ²•, ν•¨μκ°€ μλ‹¤.
    - JPAλ” νΉμ • DBμ— μΆ…μ†ν•μ§€ μ•κ³ , JPQLμ„ μ΄μ©ν•΄ μ§μ ‘ SQLμ„ μ‘μ„±ν•κ³  μ‹¤ν–‰ν•λ” μ¶”μƒν™” λ λ²¨μ„ μ κ³µν•κΈ° λ•λ¬Έμ— λ³„λ„ Dialect μ„¤μ •μΌλ΅ JPAκ°€ νΉμ • DBMSμ— λ§λ” μΏΌλ¦¬ μƒμ„±
  - λ‹¨μ 
    - SpringBootμ—μ„λ” μ—°κ²°λ DBμ— λ§κ² μλ™μΌλ΅ μ§€μ •λλ―€λ΅, μλ™ μ„¤μ •ν•  ν•„μ” μ—†μ
    - νΈν™λμ§€ μ•μ€ λ²„μ „ Dialect μ„¤μ •μΌλ΅ μλ„μΉ μ•μ€ κ²°κ³Όκ°€ λ°μƒν•  μ μμ
      - νΈλμ­μ… λ™μ‘ν•μ§€ μ•λ” ν„μƒ
      - λ²„μ „ μ°¨μ΄λ΅ μΈν•΄ DateTime νƒ€μ…μ—μ„ λ°€λ¦¬μ„Έμ»¨λ“ μ €μ¥μ΄ μ• λλ” ν„μƒ
- OSIV
  - API μ‘λ‹µ μ „μ†΅κΉμ§€ μμ†μ„± μ»¨ν…μ¤νΈμ™€ DB μ»¤λ„¥μ…μ„ μ μ§€
  - μμ†μ„± μ»¨ν…μ¤νΈ λ²”μ„κ°€ View λ λ²¨κΉμ§€ μ΄μ–΄μ§
    - View λ λ²¨μ—μ„ μ§€μ—°λ΅λ”© λ“± κΈ°λ¥ μ΄μ© κ°€λ¥
    - View λ λ²¨μ—μ„λ„ μ—”ν‹°ν‹° λ³€κ²½ κ°μ§€ λ™μ‘
  - open-in-view=false
    - μμ†μ„± μ»¨ν…μ¤νΈλ” View λ λ²¨κΉμ§€ μ μ§€
      - μμ†μ„± μ»¨ν…μ¤νΈ μƒμ„±, μΆ…λ£ β†’ View λ λ²¨
    - View λ λ²¨μ€ μμ • λ¶κ°€ + μ„λΉ„μ¤ λ λ²¨μ€ μμ • κ°€λ¥ but MVC μ „λ°μ— μμ†μ„± μ»¨ν…μ¤νΈ μ μ§€